# Copilot / AI Agent Instructions for teg_vereinsapp

This file gives focused, actionable guidance to AI coding agents working on this Flutter app.

Overview
- Purpose: a Flutter mobile/web app for a sports club (German texts and conventions).
- Architecture: classic Flutter + Provider state management. Key layers:
  - `lib/models/`: plain data models (e.g. `user.dart`, `news.dart`).
  - `lib/providers/`: `ChangeNotifier` providers. Many accept an auth token in the constructor.
  - `lib/screens/` and `lib/popUps/`: UI. File names and UI labels are often German.
  - `lib/firebase_options.dart` + `assets/service-account.json`: Firebase config/credentials (already checked into the repo).

Important patterns
- Auth / token propagation: `AuthorizationProvider` (in `lib/providers/auth_provider.dart`) stores the Firebase idToken and exposes `writeToken`. The app bootstraps a single `AuthorizationProvider` and then uses `ChangeNotifierProxyProvider<AuthorizationProvider, XProvider>` in `lib/main.dart` to inject the token into other providers. When modifying or creating providers, follow this pattern.
- Network / DB: Realtime Database is accessed via plain `http` calls to `https://db-teg-default-rtdb.firebaseio.com/...` and Firebase Identity Toolkit endpoints (hard-coded API keys exist in `auth_provider.dart`). Some code writes image data as base64 strings into `photoBlob` fields in the DB. When changing data shape, update both provider serialization (`toJson`) and any UI forms that set controller values.
- Storage: `FlutterSecureStorage` is used for credentials/tokens. Do not replace with SharedPreferences without verifying security implications.
- Date formats: The app commonly stores dates as `yyyy-MM-dd` in the backend and shows `dd.MM.yyyy` in UI (see `news_provider.dart`). Preserve that mapping.
- Push notifications: `PushNotificationService` is initialized after app start. A top-level background handler `_firebaseMessagingBackgroundHandler` is required and must call `Firebase.initializeApp()` (see `main.dart`).

Code conventions & common edits
- Provider constructors: many are declared as `ClassName(this._token)` and expect a nullable token. When updating provider lifecycles, preserve `create: (_) => XProvider(null)` and `update: (_, auth, prev) => XProvider(auth.writeToken)` pattern.
- Naming: UI classes and route names are often German (e.g., `AddMannschaftScreen`, `GetraenkeBuchenScreen`). Keep translated strings where appropriate and prefer adding new text in German to be consistent.
- Hard-coded keys: API keys and DB URLs exist in repository (e.g., `firebase_options.dart`, `auth_provider.dart`). Treat them as authoritative for local debugging; coordinate before rotating them.

Build / run / debug
- Common commands (Windows PowerShell):
  - `flutter pub get`
  - `flutter run -d <deviceId>` (or `-d chrome` for web)
  - `flutter build apk` / `flutter build ios`
- Notes: Firebase requires platform setup; `lib/firebase_options.dart` is generated by FlutterFire CLI. If you regenerate Firebase options, run `flutter pub get` and verify `DefaultFirebaseOptions.currentPlatform` entries.

Testing & quick checks
- There are no platform-specific unit tests in the repo. Use `flutter analyze` and `flutter test` to run static analysis and unit tests if added.

Areas to be careful about (discovered in repo)
- Direct use of `http` + identitytoolkit endpoints: changing authentication flows must preserve existing token storage and refresh behavior. `AuthorizationProvider.signIn` stores tokens and also saves email/password to secure storage (used by main to re-login). Be cautious before removing this behavior.
- Images saved as base64 in Realtime Database (`photoBlob`) can inflate DB size. If you change the storage approach (e.g., Cloud Storage URLs), update upload/download logic and database schema in providers and all UI that expects `photoBlob`.
- Background messaging: background handler must be top-level and reinitialize Firebase.

Files you should read first
- `lib/main.dart` — app boot, provider wiring, routes.
- `lib/providers/auth_provider.dart` — token lifecycle, secure storage, signIn/signUp.
- `lib/providers/news_provider.dart` — example of Realtime DB usage, image base64 handling, pagination.
- `lib/models/user.dart` — mapping between Firestore doc and User model.
- `lib/firebase_options.dart` and `assets/service-account.json` — Firebase config and service credentials.

When making changes
- Preserve provider token wiring and `ChangeNotifierProxyProvider` pattern.
- Update `pubspec.yaml` assets list if you add/remove files used by the app.
- Run `flutter pub get` and then `flutter run` to smoke-test on a device/emulator.

If unsure, ask the maintainer for:
- Whether API keys and `service-account.json` should be rotated or moved to secrets.
- Approval before migrating image storage or auth flows (these impact DB storage and existing users).

End.
